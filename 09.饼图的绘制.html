<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title></title>
    <style>
    canvas {
        border: 1px solid black;
    }
    </style>
</head>

<body>
    <canvas width="600" height="400" id="cas"></canvas>
</body>
<script>
	// 处理弧度与角度的计算
	function toAngle(radian) {
	    return radian * 180 / Math.PI;
	}

	function toRadian(angle) {
	    return angle * Math.PI / 180;
	}

	var cas = document.getElementById('cas');
	var ctx = cas.getContext('2d');

	var colors = "crimson,cyan,darkblue,darkcyan,darkgoldenrod,darkgray,darkgreen,darkgrey,darkkhaki,darkmagenta".split(',');

	var data = [{
	        num: 11231,
	        name: "淘宝"
	    },
	    {
	        num: 22673,
	        name: "京东"
	    },
	    {
	        num: 6123,
	        name: "唯品会"
	    },
	    {
	        num: 8989,
	        name: "1号店"
	    },
	    {
	        num: 6700,
	        name: "聚美优品"
	    }
	];

	//计算总和
	var total = 0;
	data.forEach(function(v,i){
		total+=v.num;
	});

	var maxNum = Math.max.apply(null,data.map(function(v,i){
		return v["num"];
	}));

	var title = "2016年购物占比情况";
	var titleWidth = ctx.measureText(title).width;
	ctx.fillText(title,cas.width/2 - titleWidth/2 ,10);

	
	//需要对数据进行重新加工的过程
	// {
	// 	num,
	// 	name,
	// 	percent,
	// 	startAngle,
	// 	endAngle
	// }
	var startAngle = -90;
	var radius = 100;
	var newData = data.map(function(v,i){
		v["percent"] = v["num"]/total;
		v["startAngle"] = startAngle;
		v["endAngle"] = startAngle +=  360*v["percent"];
		v["color"] = colors[i];
		v["radius"] = radius * v["num"]/maxNum;
		return v;
	});

	var circleX = cas.width/2;
	var circleY = cas.height/2;
	
	var outLength = 50;
	var lineWidth = 50;
	var textPadding = 10;

	newData.forEach(function(v,i){


		//绘制扇形
		ctx.beginPath();
		ctx.fillStyle = v["color"];
		ctx.moveTo(circleX,circleY);
		ctx.arc(circleX,circleY,v.radius,toRadian(v.startAngle),toRadian(v.endAngle));
		ctx.fill();

		var desc = v.name + (v.percent * 100).toFixed(2) + "%(" + v.num + "元)";
		lineWidth = ctx.measureText(desc).width + textPadding * 2;

		//开始绘制直线
		var lineAngle = v.startAngle + (v.endAngle - v.startAngle)/2;
		var textStartX = circleX + (radius + outLength) * Math.cos(toRadian(lineAngle));
		var textStartY = circleY + (radius + outLength) * Math.sin(toRadian(lineAngle));
		var textEndX = textStartX + lineWidth;
		var textEndY = textStartY;


		var isRight = true;
		if(lineAngle < 90 && lineAngle > -90) {
			textEndX = textStartX + lineWidth;
			ctx.textAlign = "left";
			isRight = true;
		} else {
			textEndX = textStartX - lineWidth;
			ctx.textAlign = "right";
			isRight = false;
		}
		ctx.beginPath();
		ctx.strokeStyle = v["color"];
		ctx.moveTo(circleX,circleY);
		ctx.lineTo(textStartX,textStartY);
		ctx.lineTo(textEndX,textEndY);
		ctx.stroke();


		//绘制文字
		
		if(isRight) {
			ctx.fillText(desc,textStartX + textPadding,textStartY - textPadding);
		} else {
			ctx.fillText(desc,textStartX - textPadding,textStartY - textPadding);
		}
		

	});

	

</script>

</html>